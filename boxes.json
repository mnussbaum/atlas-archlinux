{
  "description": "This templates takes virtual machines created with machines.json, installs guest utils and exports them to Vagrant Cloud",
  "variables": {
    "archversion": null,
    "pathtoiso": null,
    "isochecksum": null,
    "isochecksumtype": null,
    "cpus": "2",
    "ramsize": "1024",
    "vramsize": "16",
    "vramsizebytes": "16384",
    "disksize": "65536",
    "outdir": "{{env `PACKER_OUTDIR`}}",
    "atlastoken": "{{env `ATLAS_TOKEN`}}",
    "shutdowncmd": "sudo systemctl poweroff"
  },
  "builders": [
    {
      "type": "virtualbox-ovf",
      "source_path": "{{user `outdir`}}/pristine/virtualbox/archlinux-{{user `archversion`}}-base.ovf",
      "output_directory": "{{user `outdir`}}/tainted/virtualbox",
      "guest_additions_mode": "disable",
      "vm_name": "archlinux-{{user `archversion`}}",
      "ssh_username": "vagrant",
      "ssh_password": "vagrant",
      "headless": true,
      "shutdown_command": "{{user `shutdowncmd`}}"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "support/shared/arm-mirrorlist",
      "destination": "/tmp/arm-mirrorlist",
      "only": [ "virtualbox-ovf" ]
    },
    {
      "type": "file",
      "source": "support/virtualbox",
      "destination": "/tmp/virtualbox",
      "only": [ "virtualbox-ovf" ]
    },
    {
      "type": "shell",
      "inline": [ "sudo /tmp/virtualbox/install.sh" ],
      "only": [ "virtualbox-ovf" ]
    }
  ],
  "post-processors": [
    [{
      "type": "vagrant",
      "output": "{{user `outdir`}}/packed/archlinux-{{.Provider}}.box",
      "keep_input_artifact": true
    }]
  ]
}
